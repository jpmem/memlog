<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/memlog/favicon.png" />
    

    <title>
        
          WSUS サーバー資料の採取手順 (手動) - Microsoft Endpoint Manager / WSUS の資料採取に関する情報公開サイト
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/memlog/css/book.css">

    
<script src="/memlog/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

<meta name="generator" content="Hexo 5.4.0"></head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/memlog/">
    <span>トップ ページへ</span>
  </a>
</div>
    <div class="book-menu">
  <h1 id="資料採取手順"><a href="#資料採取手順" class="headerlink" title="資料採取手順"></a>資料採取手順</h1><ul>
<li><a href="/memlog/categories/general">一般</a></li>
<li><a href="/memlog/categories/configmgr">ConfigMgr</a></li>
<li><a href="/memlog/categories/wsus">WSUS</a></li>
<li><a href="/memlog/categories/wua">WUA</a></li>
</ul>
<h1 id="リンク"><a href="#リンク" class="headerlink" title="リンク"></a>リンク</h1><ul>
<li><a target="_blank" rel="noopener" href="https://cssjpn.github.io/">日本マイクロソフト サポート情報</a></li>
<li><a href="https://jpmem.github.io/blog/">Japan Microsoft Intune Support Blog</a></li>
</ul>

</div>


<script src="/memlog/js/book-menu.js"></script>

  </div>

  <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
  <div class="sidebar-toggle-inner"></div>
</div>

<script>
function add_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.add('show')  
}

function remove_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.remove('show')
}

function sidebar_toggle() {
    let sidebar_toggle = document.querySelector('.sidebar-toggle')
    let sidebar = document.querySelector('.book-sidebar')
    let content = document.querySelector('.off-canvas-content')
    if (sidebar_toggle.classList.contains('extend')) { // show
        sidebar_toggle.classList.remove('extend')
        sidebar.classList.remove('hide')
        content.classList.remove('extend')
    }
    else { // hide
        sidebar_toggle.classList.add('extend')
        sidebar.classList.add('hide')
        content.classList.add('extend')
    }
}
</script>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <h1 id="WSUS-サーバー資料の採取手順について"><a href="#WSUS-サーバー資料の採取手順について" class="headerlink" title="WSUS サーバー資料の採取手順について"></a>WSUS サーバー資料の採取手順について</h1><p>何らかの理由により、 CMCollector による資料採取が出来ない場合において、WSUS サーバーの資料を採取いただく際の手順を以下にご案内します。<br>なお、お問い合わせの内容によっては、追加の資料採取手順を担当者よりご案内することもございますので、ご了承くださいますようお願い致します。</p>
<h2 id="採取いただきたい内容"><a href="#採取いただきたい内容" class="headerlink" title="採取いただきたい内容"></a>採取いただきたい内容</h2><ol>
<li>WSUS サーバー ログ</li>
<li>WID ログ</li>
<li>IIS 構成情報</li>
<li>IIS ログ</li>
<li>イベント ログ</li>
<li>システム情報</li>
<li>レジストリ情報</li>
<li>グループ ポリシー情報</li>
<li>PowerShell コマンドの出力結果</li>
</ol>
<h3 id="1-WSUS-サーバー-ログ"><a href="#1-WSUS-サーバー-ログ" class="headerlink" title="1. WSUS サーバー ログ"></a>1. WSUS サーバー ログ</h3><p>WSUS サーバーの下記フォルダーを圧縮の上、取得をお願いします。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%programfiles%\Update Services\LogFiles</span><br></pre></td></tr></table></figure>

<h3 id="2-WID-ログ"><a href="#2-WID-ログ" class="headerlink" title="2. WID ログ"></a>2. WID ログ</h3><p>WSUS のデータベースに Windows Internal Database (WID) を使用している場合、下記フォルダーを圧縮の上、取得をお願いします。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%windir%\WID\Log</span><br></pre></td></tr></table></figure>

<p>WID か SQL Server か、どちらのデータベースを現在利用しているかにつきましては、WSUS サーバーの以下のレジストリから判断できます。<br>“SqlServerName” の値が %computername%\MICROSOFT##SSEE もしくは MICROSOFT##WID となっていれば、WID です。それ以外は SQL Server です。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Update Services\Server\Setup]</span><br><span class="line">&quot;SqlServerName&quot;</span><br></pre></td></tr></table></figure>

<h3 id="3-IIS-構成情報"><a href="#3-IIS-構成情報" class="headerlink" title="3. IIS 構成情報"></a>3. IIS 構成情報</h3><p>IIS の構成情報は、通常 %SystemRoot%\system32\inetsrv\config\applicationHost.config、およびアプリケーションの物理ディレクトリ (Program Files\Update Services\WebServices) 配下にある web.config に保存されています。<br>WSUS サーバーの以下のフォルダーに存在する applicationHost.config および web.config をご提供ください。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- %SystemRoot%\system32\inetsrv\config\applicationHost.config</span><br><span class="line">- %programfiles%\Update Services\WebServices\ApiRemoting30\web.config</span><br><span class="line">- %programfiles%\Update Services\WebServices\ClientWebService\web.config</span><br><span class="line">- %programfiles%\Update Services\WebServices\DssAuthWebService\web.config</span><br><span class="line">- %programfiles%\Update Services\WebServices\ReportingWebService\web.config</span><br><span class="line">- %programfiles%\Update Services\WebServices\ServerSyncWebService\web.config</span><br><span class="line">- %programfiles%\Update Services\WebServices\SimpleAuthWebService\web.config</span><br><span class="line">- &lt;WsusContent フォルダー&gt;\web.config (存在する場合)</span><br></pre></td></tr></table></figure>

<h3 id="4-IIS-ログ"><a href="#4-IIS-ログ" class="headerlink" title="4. IIS ログ"></a>4. IIS ログ</h3><p>WSUS サーバーにて、下記のパスに保存されている IIS のログ ファイルの採取をお願いします。<br>あまりにも容量が大きくなるようであれば、事象発生日前後含む 3 日分程度で結構です。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- %Windir%\System32\LogFiles\HTTPERR 配下のファイル</span><br><span class="line">- %SystemDrive%\inetpub\LogFiles\W3SVCn または %Windir%\System32\LogFiles\W3SVCn 配下のファイル (n = サイトID: 既定のWebサイトは1です）</span><br></pre></td></tr></table></figure>

<p>※ IIS ログは既定で有効となっておりませんため、ファイルが存在しない場合は不要です。<br>有効化する場合は、以下の手順を実施した後、事象を再現させた上でご採取いただけますと幸いでございます。  </p>
<ol>
<li>サーバー マネージャーを起動します。  </li>
<li>「役割と機能の追加」をクリックします。  </li>
<li>「次へ」をクリックします。  </li>
<li>「役割ベースまたは機能ベースのインストール」を選択したまま、「次へ」をクリックします。  </li>
<li>「サーバー プールからサーバーを選択」を選択したまま、「次へ」をクリックします。  </li>
<li>以下を選択し、「次へ」をクリックします。  </li>
</ol>
<p>[Web サーバー (IIS)] - [Web サーバー] - [状態と診断] -  [HTTP ログ]  </p>
<ol start="7">
<li>「次へ」をクリックします。  </li>
<li>「インストール」をクリックします。  </li>
<li>インストールが完了しましたら、「閉じる」をクリックします。</li>
</ol>
<h3 id="5-イベント-ログ"><a href="#5-イベント-ログ" class="headerlink" title="5. イベント ログ"></a>5. イベント ログ</h3><p>イベント ビューアーよりアプリケーション、システム、セキュリティのログを保存してください。<br>イベント ログ形式とテキスト形式での保存をお願いします。</p>
<h3 id="6-システム情報"><a href="#6-システム情報" class="headerlink" title="6. システム情報"></a>6. システム情報</h3><p>以下の手順で出力した txt ファイルの取得をお願いします。</p>
<ol>
<li>[ファイル名を指定して実行] より、”msinfo32” を開きます。</li>
<li>[システム情報] 画面が開きますので、メニュー バーより、[ファイル] - [エクスポート] を選択します。</li>
<li>任意の名前を入力し、txt 形式で保存します。</li>
</ol>
<h3 id="7-レジストリ情報"><a href="#7-レジストリ情報" class="headerlink" title="7. レジストリ情報"></a>7. レジストリ情報</h3><p>以下のレジストリ キーをエクスポートしたファイルの取得をお願いします。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Update Services</span><br><span class="line">- HKEY_LOCAL_MACHINE\SOFTWARE\Policies</span><br></pre></td></tr></table></figure>

<p>レジストリのエクスポート手順は以下をご参照ください。<br><a href="https://jpmem.github.io/memlog/general/registry/export-reg.html">https://jpmem.github.io/memlog/general/registry/export-reg.html</a></p>
<h3 id="8-グループ-ポリシー情報"><a href="#8-グループ-ポリシー情報" class="headerlink" title="8. グループ ポリシー情報"></a>8. グループ ポリシー情報</h3><p>以下の手順で出力した htm ファイルの取得をお願いします。</p>
<ol>
<li>管理者権限でコマンド プロンプトを起動し、任意のフォルダーに移動のうえ下記コマンドを実行します。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpresult /H gpresult.htm</span><br></pre></td></tr></table></figure></li>
<li>移動先フォルダーに出力された gpresult.htm を取得します。</li>
</ol>
<h2 id="9-PowerShell-コマンドの出力結果"><a href="#9-PowerShell-コマンドの出力結果" class="headerlink" title="9. PowerShell コマンドの出力結果"></a>9. PowerShell コマンドの出力結果</h2><p>WSUS サーバー上で「管理者として実行」にて起動した PowerShell コンソールで以下のコマンドを実行して出力された以下のファイルを採取してください。  </p>
<ul>
<li>WSUS_ServerInfo.txt</li>
<li>WSUS_SyncInfo.txt</li>
<li>WSUS_ClientInfo.txt</li>
</ul>
<p>出力先のパスは C:\temp ですが、変更されたい場合は、1 行目を任意のパスに変更の上、ファイルを採取してください。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$outWSUSPath</span> = <span class="string">&quot;C:\temp&quot;</span></span><br><span class="line"><span class="variable">$wsus</span> = <span class="built_in">Get-WsusServer</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$traceFile</span> = <span class="built_in">Join-Path</span> <span class="variable">$outWSUSPath</span> <span class="literal">-ChildPath</span> <span class="string">&quot;WSUS_ServerInfo.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$wsus</span>.GetStatus() | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line"><span class="variable">$wsus</span>.GetComponentsWithErrors() | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line"><span class="variable">$wsus</span>.GetDatabaseConfiguration() | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line"><span class="variable">$wsusconfig</span> = <span class="variable">$wsus</span>.GetConfiguration()</span><br><span class="line"><span class="variable">$wsusconfig</span>.GetEnabledUpdateLanguages() | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line"><span class="variable">$wsusconfig</span> | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$traceFile</span> = <span class="built_in">Join-Path</span> <span class="variable">$outWSUSPath</span> <span class="literal">-ChildPath</span> <span class="string">&quot;WSUS_SyncInfo.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$wsussubscription</span> = <span class="variable">$wsus</span>.GetSubscription()</span><br><span class="line"><span class="variable">$wsussubscription</span>.GetUpdateCategories() | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line"><span class="variable">$wsussubscription</span>.GetUpdateClassifications() | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line"><span class="variable">$wsussubscription</span>.GetLastSynchronizationInfo() | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line"><span class="variable">$wsussubscription</span>.GetLastSynchronizationInfo().UpdateErrors | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line"><span class="variable">$eventHistory</span> = <span class="variable">$wsussubscription</span>.GetEventHistory([<span class="built_in">DateTime</span>]::Now.AddDays(<span class="literal">-7</span>), [<span class="built_in">DateTime</span>]::Now)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$eventHistory</span>.Count <span class="operator">-lt</span> <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">     <span class="string">&quot;  None.&quot;</span> | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span>  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$event</span> <span class="keyword">in</span> <span class="variable">$eventHistory</span>)</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="string">&quot;  <span class="variable">$</span>(<span class="variable">$event</span>.CreationDate) - <span class="variable">$</span>(<span class="variable">$event</span>.Message)&quot;</span> | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span>  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$traceFile</span> = <span class="built_in">Join-Path</span> <span class="variable">$outWSUSPath</span> <span class="literal">-ChildPath</span> <span class="string">&quot;WSUS_ClientInfo.txt&quot;</span></span><br><span class="line"><span class="variable">$computerTargetGroups</span> = <span class="variable">$wsus</span>.GetComputerTargetGroups()</span><br><span class="line"><span class="variable">$computerTargetGroups</span> | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$computerTargetGroups</span>.Count <span class="operator">-lt</span> <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;  None.&quot;</span> | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span>  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$targetGroup</span> <span class="keyword">in</span> <span class="variable">$computerTargetGroups</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$targets</span> = <span class="variable">$targetGroup</span>.GetComputerTargets()</span><br><span class="line">         <span class="string">&quot;  ----&quot;</span> | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line">         <span class="string">&quot;  Target Group: <span class="variable">$</span>(<span class="variable">$targetGroup</span>.Name)&quot;</span> | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line">         <span class="string">&quot;    Number of computers in group: <span class="variable">$</span>(<span class="variable">$targets</span>.Count)&quot;</span> | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$computer</span> <span class="keyword">in</span> <span class="variable">$targets</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$temp</span> = <span class="string">&quot;      Computer: <span class="variable">$</span>(<span class="variable">$computer</span>.FullDomainName)`t&quot;</span></span><br><span class="line">            <span class="variable">$temp</span> += <span class="string">&quot; LastStatus: <span class="variable">$</span>(<span class="variable">$computer</span>.LastReportedStatusTime)&quot;</span></span><br><span class="line">            <span class="variable">$temp</span> += <span class="string">&quot; LastSync: <span class="variable">$</span>(<span class="variable">$computer</span>.LastSyncTime)&quot;</span></span><br><span class="line">            <span class="variable">$temp</span> += <span class="string">&quot; (OS Version <span class="variable">$</span>(<span class="variable">$computer</span>.OSInfo.Version.Major).<span class="variable">$</span>(<span class="variable">$computer</span>.OSInfo.Version.Minor) SP<span class="variable">$</span>(<span class="variable">$computer</span>.OSInfo.Version.ServicePackMajor)&quot;</span></span><br><span class="line">            <span class="variable">$temp</span> += <span class="string">&quot; Build <span class="variable">$</span>(<span class="variable">$computer</span>.OSInfo.Version.Build))&quot;</span></span><br><span class="line">            <span class="variable">$temp</span> | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;&quot;</span> | <span class="built_in">Out-File</span> <span class="variable">$traceFile</span> <span class="literal">-Append</span>  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div>


  <div class="book-comments">
    




  </div>



<script src="/memlog/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">
  
    <div class="link">
      <a class="category-link" href="/memlog/categories/wsus/">WSUS</a> <a class="category-link" href="/memlog/categories/wsus/initial/">Initial</a>

      
    </div>
  
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/memlog/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/memlog/js/book.js"></script>
